generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String             @id @default(uuid())
  email                   String             @unique
  password                String
  name                    String
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt
  resetPasswordExpires    DateTime?
  resetPasswordToken      String?
  language                String?
  notificationPreferences Json?
  preferences             Json?
  region                  String?
  isSuperadmin            Boolean            @default(false)
  isDisabled              Boolean            @default(false)
  tenantId                String?
  branchId                String?
  AuditLog                AuditLog[]
  MpesaTransaction        MpesaTransaction[]
  Notification            Notification[]
  Sale                Sale[]
  Subscription        Subscription[]
  Branch                  Branch?            @relation("UserBranch", fields: [branchId], references: [id])
  tenant                  Tenant?            @relation(fields: [tenantId], references: [id])
  UserBranchRole          UserBranchRole[]   @relation("UserUserBranchRoles")
  grantedPermissions      UserPermission[]   @relation("UserPermissions")
  userPermissions         UserPermission[]   @relation("UserUserPermissions")
  userRoles               UserRole[]         @relation("UserUserRoles")
  productAdditions        ProductAdditionRecord[] @relation("UserProductAdditions")
  expenses                Expense[]
  salarySchemes           SalaryScheme[]
  loginHistory            LoginHistory[]
  conversations           Conversation[]
  userPreferences         UserPreference[]
  authSessions            AuthSession[]
  authDevices             AuthDevice[]

  @@index([email])
  @@index([branchId])
  @@index([resetPasswordToken])
}

model Role {
  id             String           @id @default(uuid())
  name           String
  description    String?
  createdAt      DateTime         @default(now())
  tenantId       String?
  updatedAt      DateTime         @updatedAt
  tenant         Tenant?          @relation(fields: [tenantId], references: [id])
  permissions    RolePermission[]
  UserBranchRole UserBranchRole[] @relation("RoleUserBranchRoles")
  userRoles      UserRole[]       @relation("RoleUserRoles")

  @@unique([name, tenantId])
}

model Permission {
  id              String           @id @default(uuid())
  description     String?
  name            String           @unique
  rolePermissions RolePermission[]
  userPermissions UserPermission[] @relation("PermissionUserPermissions")
}

model RolePermission {
  id           String     @id @default(uuid())
  roleId       String
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id])
  role         Role       @relation(fields: [roleId], references: [id])
}

model UserRole {
  id       String @id @default(uuid())
  userId   String
  roleId   String
  tenantId String
  role     Role   @relation("RoleUserRoles", fields: [roleId], references: [id])
  tenant   Tenant @relation("TenantUserRoles", fields: [tenantId], references: [id])
  user     User   @relation("UserUserRoles", fields: [userId], references: [id])

  @@unique([userId, roleId, tenantId])
  @@index([roleId])
  @@index([tenantId])
  @@index([userId])
}

model Tenant {
  id                  String                @id @default(uuid())
  name                String
  businessType        String
  contactEmail        String
  contactPhone        String?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  address             String?
  currency            String?               @default("KES")
  logoUrl             String?
  timezone            String?               @default("Africa/Nairobi")
  vatNumber           String?
  city                String?
  country             String?
  taxId               String?
  website             String?
  annualRevenue       String?
  apiKey              String?
  backupRestore       Boolean               @default(false)
  businessCategory    String?
  businessDescription String?
  businessHours       Json?
  businessLicense     String?
  businessSubcategory String?
  customDomain        String?
  customIntegrations  Boolean               @default(false)
  employeeCount       String?
  etimsQrUrl          String?
  favicon             String?
  foundedYear         Int?
  invoiceFooter       String?
  kraPin              String?
  latitude            Float?
  longitude           Float?
  postalCode          String?
  primaryColor        String?
  primaryProducts     Json?
  rateLimit           Int?
  receiptLogo         String?
  secondaryColor      String?
  secondaryProducts   Json?
  socialMedia         Json?
  ssoEnabled          Boolean               @default(false)
  state               String?
  stripeCustomerId    String?               @unique
  watermark           String?
  webhookUrl          String?
  whiteLabel          Boolean               @default(false)
  dashboardLogoUrl    String?
  emailLogoUrl        String?
  loginLogoUrl        String?
  logoSettings        Json?
  pdfTemplate         Json?
  mobileLogoUrl       String?
  auditLogsEnabled    Boolean               @default(false)
  credits             Float?                @default(0)
  mpesaConsumerKey    String?
  mpesaConsumerSecret String?
  mpesaShortCode      String?
  mpesaPasskey        String?
  mpesaCallbackUrl    String?
  mpesaIsActive       Boolean               @default(false)
  mpesaEnvironment    String?               @default("sandbox")
  Branch              Branch[]
  Inventory           Inventory[]
  InventoryMovement   InventoryMovement[]
  InventoryAlert      InventoryAlert[]
  InventoryLocation   InventoryLocation[]
  Invoice             Invoice[]
  MpesaTransaction    MpesaTransaction[]
  Notification        Notification[]
  Payment             Payment[]
  PaymentMethod       PaymentMethod[]
  products            Product[]             @relation("TenantProducts")
  roles               Role[]
  Sale                Sale[]
  Credit              Credit[]
  Subscription        Subscription[]
  suppliers           Supplier[]
  TenantConfiguration TenantConfiguration[]
  TenantModule        TenantModule[]
  users               User[]
  UserBranchRole      UserBranchRole[]      @relation("TenantUserBranchRoles")
  userPermissions     UserPermission[]      @relation("TenantUserPermissions")
  userRoles           UserRole[]            @relation("TenantUserRoles")
  productAdditions    ProductAdditionRecord[] @relation("TenantProductAdditions")
  productVariations   ProductVariation[]    @relation("TenantProductVariations")
  productAttributes   ProductAttribute[]    @relation("TenantProductAttributes")
  expenses            Expense[]             // New
  expenseCategories   ExpenseCategory[]     // New
  salesTargets         SalesTarget[]         // New
  salarySchemes        SalaryScheme[]        // New
  loginHistory         LoginHistory[]

  @@index([name])
}

model AuditLog {
  id        String   @id
  userId    String?
  action    String
  details   Json?
  ip        String?
  createdAt DateTime @default(now())
  User      User?    @relation(fields: [userId], references: [id])
}

model Branch {
  id             String           @id @default(uuid())
  name           String
  address        String?
  tenantId       String
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  city           String?
  country        String?
  customField    String?
  email          String?
  isMainBranch   Boolean          @default(false)
  logo           String?
  manager        String?
  openingHours   String?
  phone          String?
  postalCode     String?
  state          String?
  status         String?
  street         String?
  tenant              Tenant              @relation(fields: [tenantId], references: [id])
  inventories         Inventory[]
  inventoryMovements  InventoryMovement[]
  inventoryAlerts     InventoryAlert[]
  inventoryLocations  InventoryLocation[]
  products            Product[]           @relation("BranchProducts")
  sales               Sale[]
  users               User[]              @relation("UserBranch")
  UserBranchRole      UserBranchRole[]    @relation("BranchUserBranchRoles")
  productAdditions    ProductAdditionRecord[] @relation("BranchProductAdditions")
  productVariations   ProductVariation[]  @relation("BranchProductVariations") // New
  expenses            Expense[]           // New
  salarySchemes       SalaryScheme[]      // New

  @@index([tenantId])
}

model Inventory {
  id           String   @id
  productId    String
  quantity     Int
  tenantId     String
  createdAt    DateTime @default(now())
  updatedAt    DateTime
  branchId     String?
  minStock     Int      @default(0)
  maxStock     Int      @default(1000)
  reorderPoint Int      @default(10)
  location     String   @default("Main Warehouse")
  branch       Branch?  @relation(fields: [branchId], references: [id])
  product      Product  @relation("ProductInventory", fields: [productId], references: [id])
  tenant       Tenant   @relation(fields: [tenantId], references: [id])

  @@index([branchId])
  @@index([productId])
  @@index([tenantId])
}

model InventoryMovement {
  id           String   @id @default(uuid())
  productId    String
  type         String   // 'in', 'out', 'adjustment', 'transfer'
  quantity     Int
  previousQuantity Int
  newQuantity  Int
  reason       String?
  location     String
  createdAt    DateTime @default(now())
  createdBy    String
  branchId     String?
  tenantId     String
  branch       Branch?  @relation(fields: [branchId], references: [id])
  product      Product  @relation(fields: [productId], references: [id])
  tenant       Tenant   @relation(fields: [tenantId], references: [id])

  @@index([branchId])
  @@index([productId])
  @@index([tenantId])
  @@index([createdAt])
}

model InventoryAlert {
  id        String   @id @default(uuid())
  productId String
  type      String   // 'low_stock', 'out_of_stock', 'over_stock', 'reorder'
  message   String
  severity  String   // 'low', 'medium', 'high', 'critical'
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  branchId  String?
  tenantId  String
  branch    Branch?  @relation(fields: [branchId], references: [id])
  product   Product  @relation(fields: [productId], references: [id])
  tenant    Tenant   @relation(fields: [tenantId], references: [id])

  @@index([branchId])
  @@index([productId])
  @@index([tenantId])
  @@index([isRead])
}

model InventoryLocation {
  id       String   @id @default(uuid())
  name     String
  type     String   // 'warehouse', 'store', 'showroom'
  address  String?
  branchId String?
  tenantId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  branch   Branch?  @relation(fields: [branchId], references: [id])
  tenant   Tenant   @relation(fields: [tenantId], references: [id])

  @@index([branchId])
  @@index([tenantId])
}

model Invoice {
  id             String        @id
  subscriptionId String?
  amount         Float
  status         String
  dueDate        DateTime?
  paidAt         DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime
  tenantId       String
  number         String        @unique
  Subscription   Subscription? @relation(fields: [subscriptionId], references: [id])
  Tenant         Tenant        @relation(fields: [tenantId], references: [id])

  @@index([subscriptionId])
  @@index([tenantId])
}

model Module {
  id           String         @id
  name         String         @unique
  description  String?
  TenantModule TenantModule[]
}

model MpesaTransaction {
  id                                 String    @id
  userId                             String?
  phoneNumber                        String
  amount                             Float
  status                             String    @default("pending")
  mpesaReceipt                       String?
  merchantRequestId                  String?
  responseCode                       String?
  responseDesc                       String?
  message                            String?
  createdAt                          DateTime  @default(now())
  updatedAt                          DateTime
  saleData                           Json?
  billRefNumber                      String?
  businessShortCode                  String?
  checkoutRequestID                  String?   @unique
  invoiceNumber                      String?
  orgAccountBalance                  String?
  saleId                             String?
  tenantId                           String
  thirdPartyTransID                  String?
  transactionId                      String?   @unique
  transactionTime                    DateTime?
  transactionType                    String?
  Sale_MpesaTransaction_saleIdToSale Sale?     @relation("MpesaTransaction_saleIdToSale", fields: [saleId], references: [id])
  Tenant                             Tenant    @relation(fields: [tenantId], references: [id])
  User                               User?     @relation(fields: [userId], references: [id])
  sale                               Sale?

  @@index([checkoutRequestID])
  @@index([mpesaReceipt])
  @@index([saleId])
  @@index([tenantId])
  @@index([userId])
}

model Notification {
  id        String    @id
  type      String
  title     String
  message   String
  isRead    Boolean   @default(false)
  data      Json?
  tenantId  String
  userId    String?
  createdAt DateTime  @default(now())
  readAt    DateTime?
  Tenant    Tenant    @relation(fields: [tenantId], references: [id])
  User      User?     @relation(fields: [userId], references: [id])
}

model Payment {
  id                    String    @id
  tenantId              String
  stripePaymentIntentId String?   @unique
  amount                Float
  currency              String    @default("KES")
  status                String
  description           String?
  metadata              Json?
  completedAt           DateTime?
  refundedAt           DateTime?
  refundAmount          Float?
  refundReason          String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime
  Tenant                Tenant    @relation(fields: [tenantId], references: [id])

  @@index([createdAt])
  @@index([status])
  @@index([tenantId])
}

model PaymentMethod {
  id        String   @id
  tenantId  String
  type      String
  last4     String?
  brand     String?
  isDefault Boolean  @default(false)
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime
  expMonth  Int?
  expYear   Int?
  Tenant    Tenant   @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
}

model Plan {
  id                 String              @id @default(uuid())
  name               String
  description        String
  price              Float
  interval           String
  maxUsers           Int?
  maxProducts        Int?
  maxSalesPerMonth   Int?
  maxBranches        Int?
  analyticsEnabled   Boolean             @default(false)
  advancedReports    Boolean             @default(false)
  prioritySupport    Boolean             @default(false)
  customBranding     Boolean             @default(false)
  apiAccess          Boolean             @default(false)
  isActive           Boolean             @default(true)
  advancedSecurity   Boolean             @default(false)
  auditLogs          Boolean             @default(false)
  backupRestore      Boolean             @default(false)
  bulkOperations     Boolean             @default(false)
  customFields       Boolean             @default(false)
  customIntegrations Boolean             @default(false)
  dataExport         Boolean             @default(false)
  dedicatedSupport   Boolean             @default(false)
  ssoEnabled         Boolean             @default(false)
  whiteLabel         Boolean             @default(false)
  stripePriceId      String?             @unique
  PlanFeatureOnPlan  PlanFeatureOnPlan[]
  Subscription       Subscription[]
  ScheduledSubscriptions Subscription[] @relation("ScheduledPlan")

  @@index([isActive])
  @@index([name])
}

model PlanFeature {
  id                 String              @id
  featureKey         String              @unique
  featureName        String
  featureDescription String?
  isEnabled          Boolean             @default(true)
  createdAt          DateTime            @default(now())
  updatedAt           DateTime
  PlanFeatureOnPlan  PlanFeatureOnPlan[]
}

model PlanFeatureOnPlan {
  id            String      @id
  planId        String
  featureId     String
  isEnabled     Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime
  stripePriceId String?     @unique
  PlanFeature   PlanFeature @relation(fields: [featureId], references: [id])
  Plan          Plan        @relation(fields: [planId], references: [id])
}

model Supplier {
  id          String    @id @default(uuid())
  name        String
  contactName String?
  email       String?
  phone       String?
  address     String?
  city        String?
  country     String?
  postalCode  String?
  website     String?
  notes       String?
  tenantId    String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  isActive    Boolean   @default(true)
  products    Product[] @relation("SupplierProducts")
  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  productAdditions ProductAdditionRecord[] @relation("SupplierProductAdditions")

  @@index([tenantId])
  @@index([email])
}



// Product Attribute Definitions (e.g., "Color", "Size", "Storage")
model ProductAttribute {
  id          String   @id @default(uuid())
  name        String   // e.g., "Color", "Size", "Storage"
  displayName String?  // e.g., "Color", "Size", "Storage Capacity"
  type        String   @default("text") // "text", "number", "color", "image"
  tenantId    String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  values      ProductAttributeValue[]
  tenant      Tenant   @relation("TenantProductAttributes", fields: [tenantId], references: [id])

  @@unique([name, tenantId])
  @@index([tenantId])
  @@index([isActive])
}

// Product Attribute Values (e.g., "Black", "Grey", "38", "256GB")
model ProductAttributeValue {
  id          String   @id @default(uuid())
  attributeId String
  value       String   // e.g., "Black", "38", "256GB"
  displayName String?  // Optional display name
  color       String?  // Hex color for color attributes
  image       String?  // Image URL for image-based attributes
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  attribute   ProductAttribute @relation(fields: [attributeId], references: [id], onDelete: Cascade)

  @@unique([attributeId, value])
  @@index([attributeId])
  @@index([isActive])
}

model ProductVariation {
  id           String   @id @default(uuid())
  productId    String
  sku          String   // Unique SKU for this variation
  price        Float?   // Override price, null means use base price
  cost         Float?   // Override cost, null means use base cost
  stock        Int      @default(0)
  attributes   Json     // {"Color": "Black", "Size": "38"} - using attribute names and values
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  tenantId     String
  branchId     String?
  barcode      String?  // Optional barcode for this variation
  weight       Float?   // Optional weight override
  product      Product  @relation("ProductVariations", fields: [productId], references: [id])
  tenant       Tenant   @relation("TenantProductVariations", fields: [tenantId], references: [id])
  branch       Branch?  @relation("BranchProductVariations", fields: [branchId], references: [id])
  saleItems    SaleItem[] @relation("VariationSaleItems")

  @@unique([productId, sku])
  @@index([productId])
  @@index([tenantId])
  @@index([branchId])
  @@index([sku])
}

model Product {
  id           String      @id
  name         String
  sku          String      // Base SKU, variations will have their own
  price        Float       // Base price
  description  String?
  tenantId     String
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  stock        Int         @default(0) // Total stock across all variations
  customFields Json?
  branchId     String?
  cost         Float       @default(0) // Base cost
  images       String[]    // Array of image URLs
  supplierId   String?
  hasVariations Boolean    @default(false) // New: Whether this product has variations
  supplier     Supplier?   @relation("SupplierProducts", fields: [supplierId], references: [id])
  inventory           Inventory[]          @relation("ProductInventory")
  inventoryMovements  InventoryMovement[]
  inventoryAlerts     InventoryAlert[]
  branch              Branch?              @relation("BranchProducts", fields: [branchId], references: [id])
  tenant              Tenant               @relation("TenantProducts", fields: [tenantId], references: [id])
  saleItems           SaleItem[]           @relation("ProductSaleItems")
  productAdditions    ProductAdditionRecord[]
  variations          ProductVariation[]   @relation("ProductVariations") // New

  @@index([branchId])
  @@index([tenantId])
  @@index([supplierId])
  @@index([createdAt])
  @@index([tenantId, branchId])
  @@index([tenantId, createdAt])
  @@index([branchId, createdAt])
  @@index([tenantId, branchId, createdAt])
}

model Sale {
  id                                             String             @id
  tenantId                                       String
  userId                                         String
  total                                          Float
  paymentType                                    String
  createdAt                                      DateTime           @default(now())
  customerName                                   String?
  customerPhone                                  String?
  mpesaTransactionId                             String?            @unique
  idempotencyKey                                 String?
  vatAmount                                      Float?
  branchId                                       String?
  MpesaTransaction_MpesaTransaction_saleIdToSale MpesaTransaction[] @relation("MpesaTransaction_saleIdToSale")
  Branch                                         Branch?            @relation(fields: [branchId], references: [id])
  mpesaTransaction                               MpesaTransaction?  @relation(fields: [mpesaTransactionId], references: [id])
  Tenant                                         Tenant             @relation(fields: [tenantId], references: [id])
  User                                           User               @relation(fields: [userId], references: [id])
  SaleItem                                       SaleItem[]
  credit                                         Credit?            @relation("SaleCredit")

  @@unique([idempotencyKey, userId])
  @@index([branchId])
  @@index([tenantId])
  @@index([userId])
}

model SaleItem {
  id          String  @id
  saleId      String
  productId   String
  variationId String? // New: Optional variation ID for product variations
  quantity    Int
  price       Float
  product     Product @relation("ProductSaleItems", fields: [productId], references: [id])
  sale        Sale    @relation(fields: [saleId], references: [id])
  variation   ProductVariation? @relation("VariationSaleItems", fields: [variationId], references: [id]) // New

  @@index([productId])
  @@index([variationId]) // New
}

model Subscription {
  id                     String    @id
  tenantId               String
  planId                 String
  scheduledPlanId        String?   // For scheduled downgrade/upgrade
  scheduledEffectiveDate DateTime? // When the scheduled plan change takes effect
  status                 String
  currentPeriodStart     DateTime
  currentPeriodEnd       DateTime
  cancelAtPeriodEnd      Boolean   @default(false)
  canceledAt             DateTime?
  stripePriceId          String
  stripeSubscriptionId   String    @unique
  stripeCurrentPeriodEnd DateTime
  stripeCustomerId       String
  trialEnd               DateTime?
  trialStart             DateTime?
  isTrial                Boolean   @default(false)
  userId                 String?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
  Invoice                Invoice[]
  Plan                   Plan      @relation(fields: [planId], references: [id])
  ScheduledPlan          Plan?     @relation("ScheduledPlan", fields: [scheduledPlanId], references: [id])
  Tenant                 Tenant    @relation(fields: [tenantId], references: [id])
  User                   User?     @relation(fields: [userId], references: [id])

  @@index([status])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@index([tenantId])
  @@index([userId])
  @@index([scheduledPlanId])
}

model SystemConfiguration {
  id          String   @id
  key         String   @unique
  value       String
  description String?
  category    String
  isEncrypted Boolean  @default(false)
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime

  @@index([category])
  @@index([key])
}
model Conversation {
  id         String   @id @default(uuid())
  userId     String
  tenantId   String
  branchId   String?
  title      String?
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  interactions  AIChatInteraction[]
  user          User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([tenantId])
  @@index([branchId])
  @@index([isActive])
}

model AIChatInteraction {
  id            String   @id @default(uuid())
  userId        String
  tenantId      String
  branchId      String?
  conversationId String?
  userMessage   String
  aiResponse    String
  metadata      Json?
  category      String?
  feedback      Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  conversation  Conversation? @relation(fields: [conversationId], references: [id])

  @@index([userId])
  @@index([tenantId])
  @@index([branchId])
  @@index([conversationId])
  @@index([category])
}

model UserPreference {
  id            String   @id @default(uuid())
  userId        String
  tenantId      String
  preferenceKey String
  preferenceValue Json
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id])

  @@unique([userId, tenantId, preferenceKey])
  @@index([userId])
  @@index([tenantId])
  @@index([preferenceKey])
}

model TenantConfiguration {
  id          String   @id
  tenantId    String
  key         String
  value       String
  description String?
  category    String
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  isEncrypted Boolean  @default(false)
  Tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, key])
  @@index([category])
  @@index([key])
  @@index([tenantId])
}

model TenantModule {
  id       String  @id
  tenantId String
  moduleId String
  enabled  Boolean @default(true)
  Module   Module  @relation(fields: [moduleId], references: [id])
  Tenant   Tenant  @relation(fields: [tenantId], references: [id])
}

model UserBranchRole {
  id       String @id
  userId   String
  branchId String
  roleId   String
  tenantId String
  Branch   Branch @relation("BranchUserBranchRoles", fields: [branchId], references: [id])
  Role     Role   @relation("RoleUserBranchRoles", fields: [roleId], references: [id])
  Tenant   Tenant @relation("TenantUserBranchRoles", fields: [tenantId], references: [id])
  User     User   @relation("UserUserBranchRoles", fields: [userId], references: [id])

  @@unique([userId, branchId, roleId])
}

model UserPermission {
  id            String     @id @default(uuid())
  userId        String
  permission    String
  permissionRef Permission @relation("PermissionUserPermissions", fields: [permission], references: [name])
  grantedBy     String?
  grantedAt     DateTime   @default(now())
  tenantId      String
  tenant        Tenant     @relation("TenantUserPermissions", fields: [tenantId], references: [id])
  user          User       @relation("UserUserPermissions", fields: [userId], references: [id])
  grantedByUser User?      @relation("UserPermissions", fields: [grantedBy], references: [id])

  @@unique([userId, permission, tenantId])
}

model ProductAdditionRecord {
  id            String   @id @default(uuid())
  productId     String
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  tenantId      String
  tenant        Tenant   @relation("TenantProductAdditions", fields: [tenantId], references: [id])
  branchId      String?
  branch        Branch?  @relation("BranchProductAdditions", fields: [branchId], references: [id])
  userId        String
  user          User     @relation("UserProductAdditions", fields: [userId], references: [id])
  supplierId    String?
  supplier      Supplier? @relation("SupplierProductAdditions", fields: [supplierId], references: [id])
  quantity      Int      @default(1)
  cost          Float?
  price         Float?
  addedAt       DateTime @default(now())
  notes         String?
  additionType  String   @default("individual") // "individual" or "bulk"

  @@index([productId])
  @@index([tenantId])
  @@index([branchId])
  @@index([userId])
  @@index([supplierId])
  @@index([addedAt])
}

model Credit {
  id            String   @id @default(uuid())
  tenantId      String
  customerName  String
  customerPhone String?
  customerEmail String?
  totalAmount   Float    // Total credit amount
  paidAmount    Float    @default(0) // Amount paid so far
  balance       Float    // Remaining balance (totalAmount - paidAmount)
  status        String   @default("active") // "active", "paid", "overdue"
  dueDate       DateTime?
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  sale          Sale     @relation("SaleCredit", fields: [saleId], references: [id])
  payments      CreditPayment[]

  saleId        String   @unique

  @@index([tenantId])
  @@index([customerPhone])
  @@index([status])
  @@index([dueDate])
}

model CreditPayment {
  id            String   @id @default(uuid())
  creditId      String
  amount        Float
  paymentMethod String   // "cash", "mpesa", "bank_transfer", etc.
  transactionId String?  // For M-Pesa or other payment references
  notes         String?
  createdAt     DateTime @default(now())

  credit        Credit   @relation(fields: [creditId], references: [id], onDelete: Cascade)

  @@index([creditId])
  @@index([createdAt])
}

model ExpenseCategory {
  id          String    @id @default(uuid())
  tenantId    String
  name        String
  description String?
  color       String?   // Hex color code for UI display
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  expenses    Expense[]

  @@unique([name, tenantId])
  @@index([tenantId])
  @@index([isActive])
}

model Expense {
  id            String           @id @default(uuid())
  tenantId      String
  userId        String
  branchId      String?
  amount        Float
  description   String
  categoryId    String?          // Reference to ExpenseCategory
  expenseType   String           // "one_time", "recurring"
  frequency     String?          // "daily", "weekly", "monthly", "yearly" (for recurring expenses)
  nextDueDate   DateTime?        // For recurring expenses
  isActive      Boolean          @default(true) // For recurring expenses
  receiptUrl    String?          // URL to uploaded receipt
  notes         String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  tenant        Tenant           @relation(fields: [tenantId], references: [id])
  user          User             @relation(fields: [userId], references: [id])
  branch        Branch?          @relation(fields: [branchId], references: [id])
  category      ExpenseCategory? @relation(fields: [categoryId], references: [id])

  @@index([tenantId])
  @@index([userId])
  @@index([branchId])
  @@index([expenseType])
  @@index([categoryId])
  @@index([nextDueDate])
  @@index([isActive])
}

model SalesTarget {
  id        Int      @id @default(autoincrement())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  name      String
  target    Float
  daily     Float
  weekly    Float
  monthly   Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Add other fields as needed

  @@index([tenantId])
}

model SalaryScheme {
  id            String   @id @default(uuid())
  tenantId      String
  userId        String
  employeeName  String
  salaryAmount  Float
  frequency     String   // 'monthly' or 'yearly'
  startDate     DateTime
  nextDueDate   DateTime? // Next date when salary should be paid
  lastPaidDate  DateTime? // Last date when salary was processed as expense
  branchId      String?
  notes         String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  user          User     @relation(fields: [userId], references: [id])
  branch        Branch?  @relation(fields: [branchId], references: [id])

  @@index([tenantId])
  @@index([userId])
  @@index([branchId])
  @@index([isActive])
  @@index([nextDueDate])
}

model LoginHistory {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  tenantId    String?
  tenant      Tenant?  @relation(fields: [tenantId], references: [id])
  loginTime   DateTime @default(now())
  ipAddress   String?
  userAgent   String?
  success     Boolean  @default(true)
  failureReason String?

  @@index([userId])
  @@index([tenantId])
  @@index([loginTime])
}

// Enterprise auth: server-side sessions + refresh tokens
model AuthSession {
  id               String    @id @default(uuid())
  userId           String
  tenantId         String?
  deviceId         String?
  refreshTokenHash String
  ip               String?
  userAgent        String?
  createdAt        DateTime  @default(now())
  lastActiveAt     DateTime  @default(now())
  expiresAt       DateTime
  revokedAt       DateTime?
  isValid          Boolean   @default(true)

  user   User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  device AuthDevice? @relation(fields: [deviceId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([userId, isValid])
  @@index([refreshTokenHash])
  @@index([expiresAt])
}

model AuthDevice {
  id          String   @id @default(uuid())
  userId      String
  fingerprint String
  name        String?
  trusted     Boolean  @default(false)
  lastSeen    DateTime @updatedAt

  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessions AuthSession[]

  @@unique([userId, fingerprint])
  @@index([userId])
}

